{% extends 'base.html' %}
{% block title %}Tableau de Bord Instructeur{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-10">
    <h1 class="text-3xl font-bold text-[#312B1E]">
        <i class="fas fa-chalkboard-teacher mr-3 text-[#A7AA63]"></i>Tableau de Bord Instructeur
    </h1>
    <p class="text-[#505039] mt-2">Gérez vos cours et suivez vos étudiants</p>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
    <!-- Cours créés -->
    <div class="group relative">
        <div
            class="absolute -inset-0.5 bg-gradient-to-r from-[#A7AA63] to-[#E2CEAE] rounded-2xl opacity-30 group-hover:opacity-60 blur-sm transition-opacity duration-500">
        </div>
        <div class="relative bg-[#F2EFE4] rounded-2xl p-6 border border-[#C5B8A8]/30">
            <div class="flex items-start justify-between mb-4">
                <div>
                    <p class="text-sm text-[#7C6B51] mb-1">Cours créés</p>
                    <p class="text-4xl font-bold text-[#312B1E]">{{ created_courses|length }}</p>
                </div>
                <div
                    class="w-12 h-12 rounded-xl bg-gradient-to-br from-[#A7AA63] to-[#E2CEAE] flex items-center justify-center shadow-warm-sm">
                    <i class="fas fa-book text-[#121A1B] text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Total étudiants -->
    <div class="group relative">
        <div
            class="absolute -inset-0.5 bg-gradient-to-r from-[#505039] to-[#7C6B51] rounded-2xl opacity-30 group-hover:opacity-60 blur-sm transition-opacity duration-500">
        </div>
        <div class="relative bg-[#F2EFE4] rounded-2xl p-6 border border-[#C5B8A8]/30">
            <div class="flex items-start justify-between mb-4">
                <div>
                    <p class="text-sm text-[#7C6B51] mb-1">Total étudiants</p>
                    {% with total_students=0 %}
                    <p class="text-4xl font-bold text-[#312B1E]">{{ enrolled_users_by_course.values|length }}</p>
                    {% endwith %}
                </div>
                <div
                    class="w-12 h-12 rounded-xl bg-gradient-to-br from-[#505039] to-[#7C6B51] flex items-center justify-center shadow-warm-sm">
                    <i class="fas fa-users text-[#FFFFFF] text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Modifications -->
    <div class="group relative">
        <div
            class="absolute -inset-0.5 bg-gradient-to-r from-[#7C6B51] to-[#C5B8A8] rounded-2xl opacity-30 group-hover:opacity-60 blur-sm transition-opacity duration-500">
        </div>
        <div class="relative bg-[#F2EFE4] rounded-2xl p-6 border border-[#C5B8A8]/30">
            <div class="flex items-start justify-between mb-4">
                <div>
                    <p class="text-sm text-[#7C6B51] mb-1">Modifications</p>
                    <p class="text-4xl font-bold text-[#312B1E]">{{ last_modifications|length }}</p>
                </div>
                <div
                    class="w-12 h-12 rounded-xl bg-gradient-to-br from-[#7C6B51] to-[#C5B8A8] flex items-center justify-center shadow-warm-sm">
                    <i class="fas fa-history text-[#FFFFFF] text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Action -->
    <div class="group relative">
        <div
            class="absolute -inset-0.5 bg-gradient-to-r from-[#312B1E] to-[#505039] rounded-2xl opacity-30 group-hover:opacity-60 blur-sm transition-opacity duration-500">
        </div>
        <div class="relative bg-[#F2EFE4] rounded-2xl p-6 border border-[#C5B8A8]/30">
            <div class="flex items-start justify-between mb-4">
                <div>
                    <p class="text-sm text-[#7C6B51] mb-1">Action rapide</p>
                    <a href="{% url 'course-create' %}"
                        class="text-[#A7AA63] hover:text-[#8e9150] font-semibold transition-colors">
                        + Nouveau cours
                    </a>
                </div>
                <div
                    class="w-12 h-12 rounded-xl bg-gradient-to-br from-[#312B1E] to-[#505039] flex items-center justify-center shadow-warm-sm">
                    <i class="fas fa-plus text-[#FFFFFF] text-xl"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Profile Form -->
<div class="bg-[#F2EFE4] p-8 rounded-2xl shadow-warm-md border border-[#C5B8A8]/30 max-w-3xl mb-12">
    <h2 class="text-2xl font-bold text-[#312B1E] mb-6 flex items-center gap-3">
        <div
            class="w-10 h-10 rounded-xl bg-gradient-to-br from-[#A7AA63] to-[#E2CEAE] flex items-center justify-center">
            <i class="fas fa-user-edit text-[#121A1B]"></i>
        </div>
        Modifier mon profil
    </h2>
    <form method="post" class="space-y-5">
        {% csrf_token %}
        {% for field in form %}
        <div class="form-field">
            <label class="block text-sm font-semibold mb-2 text-[#505039]" for="{{ field.id_for_label }}">
                {{ field.label }}
            </label>
            {{ field }}
            {% for error in field.errors %}
            <p class="text-[#312B1E] text-sm mt-1 flex items-center gap-1">
                <i class="fas fa-exclamation-triangle text-[#7C6B51]"></i>{{ error }}
            </p>
            {% endfor %}
        </div>
        {% endfor %}
        <button type="submit" class="btn-primary">
            <i class="fas fa-save"></i>
            Mettre à jour
        </button>
    </form>
</div>

<!-- Separator -->
<div class="h-px bg-gradient-to-r from-transparent via-[#C5B8A8] to-transparent mb-12"></div>

<!-- My Courses -->
<div class="mb-12">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-[#312B1E] flex items-center gap-3">
            <i class="fas fa-book text-[#A7AA63]"></i>
            Mes Cours Créés
        </h2>
        <a href="{% url 'course-create' %}" class="btn-primary">
            <i class="fas fa-plus"></i>
            Créer un cours
        </a>
    </div>

    {% if created_courses %}
    <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
        {% for course in created_courses %}
        <div class="group course-card cursor-pointer" data-href="{% url 'course-detail' course.pk %}">
            <div class="bg-[#F2EFE4] rounded-2xl border border-[#C5B8A8]/30 overflow-hidden transition-all duration-500
                        hover:shadow-[0_12px_24px_rgba(49,43,30,0.15),0_6px_12px_rgba(49,43,30,0.1)]
                        hover:-translate-y-2 hover:border-[#A7AA63] flex flex-col h-full">
                <!-- Image -->
                <div class="relative h-40 overflow-hidden">
                    {% if course.image %}
                    <img src="{{ course.image.url }}" alt="{{ course.title }}"
                        class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                    {% else %}
                    <div
                        class="w-full h-full bg-gradient-to-br from-[#505039] to-[#312B1E] flex items-center justify-center">
                        <i class="fas fa-book text-5xl text-[#FFFFFF]/30"></i>
                    </div>
                    {% endif %}

                    <!-- Stats overlay -->
                    <div class="absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-[#312B1E]/80 to-transparent">
                        <div class="flex items-center gap-3 text-xs text-[#EAE6D2]">
                            <span><i class="fas fa-users mr-1"></i>{{ course.enrollments.count }}</span>
                            <span><i class="fas fa-layer-group mr-1"></i>{{ course.modules.count }}</span>
                        </div>
                    </div>
                </div>

                <!-- Content -->
                <div class="p-5 flex flex-col flex-1">
                    <h3
                        class="text-lg font-semibold text-[#312B1E] mb-2 group-hover:text-[#A7AA63] transition-colors line-clamp-2">
                        {{ course.title }}
                    </h3>
                    <p class="text-sm text-[#7C6B51] mb-4 line-clamp-2">{{ course.description|truncatechars:60 }}</p>

                    <div class="mt-auto flex gap-2" onclick="event.stopPropagation()">
                        <a href="{% url 'course-update' course.pk %}"
                            class="btn-sm btn-outline-warning flex-1 justify-center">
                            <i class="fas fa-edit"></i>
                        </a>
                        <button type="button" class="btn-sm btn-outline-danger flex-1 justify-center delete-trigger"
                            data-delete-url="{% url 'course-delete' course.pk %}"
                            data-item-title="{{ course.title|escapejs }}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-16 bg-[#F2EFE4] rounded-2xl border border-[#C5B8A8]/30">
        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-[#E2CEAE] flex items-center justify-center">
            <i class="fas fa-book-open text-2xl text-[#7C6B51]"></i>
        </div>
        <p class="text-[#7C6B51] mb-4">Vous n'avez pas encore créé de cours.</p>
        <a href="{% url 'course-create' %}" class="btn-primary">
            <i class="fas fa-plus"></i>
            Créer mon premier cours
        </a>
    </div>
    {% endif %}
</div>

<!-- Separator -->
<div class="h-px bg-gradient-to-r from-transparent via-[#C5B8A8] to-transparent mb-12"></div>

<!-- Recent Modifications -->
<div class="mb-12">
    <h2 class="text-2xl font-bold text-[#312B1E] mb-6 flex items-center gap-3">
        <i class="fas fa-history text-[#7C6B51]"></i>
        Dernières Modifications
    </h2>

    {% if last_modifications %}
    <div class="bg-[#F2EFE4] rounded-2xl border border-[#C5B8A8]/30 overflow-hidden">
        <ul class="divide-y divide-[#C5B8A8]/30">
            {% for modif in last_modifications %}
            <li class="p-4 hover:bg-[#EAE6D2] transition-colors">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-lg bg-[#E2CEAE] flex items-center justify-center">
                        <i class="fas fa-edit text-[#7C6B51]"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-[#312B1E]">{{ modif.description }}</p>
                        <p class="text-sm text-[#7C6B51]">
                            <i class="fas fa-clock mr-1"></i>{{ modif.modified_at|date:"d/m/Y H:i" }}
                        </p>
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% else %}
    <div class="text-center py-12 bg-[#F2EFE4] rounded-2xl border border-[#C5B8A8]/30">
        <p class="text-[#7C6B51]">Aucune modification récente enregistrée.</p>
    </div>
    {% endif %}
</div>

<!-- Separator -->
<div class="h-px bg-gradient-to-r from-transparent via-[#C5B8A8] to-transparent mb-12"></div>

<!-- Enrolled Students -->
<div class="mb-12">
    <h2 class="text-2xl font-bold text-[#312B1E] mb-6 flex items-center gap-3">
        <i class="fas fa-users text-[#505039]"></i>
        Étudiants Inscrits à Vos Cours
    </h2>

    {% if enrolled_users_by_course %}
    <div class="space-y-6">
        {% for course, users in enrolled_users_by_course.items %}
        <div class="bg-[#F2EFE4] rounded-2xl border border-[#C5B8A8]/30 overflow-hidden shadow-warm-sm">
            <div class="p-5 bg-gradient-to-r from-[#F2EFE4] to-[#EAE6D2] border-b border-[#C5B8A8]/30">
                <h3 class="text-lg font-semibold text-[#312B1E] flex items-center gap-2">
                    <i class="fas fa-book text-[#A7AA63]"></i>
                    {{ course.title }}
                    <span class="ml-auto px-3 py-1 rounded-full text-xs font-semibold bg-[#A7AA63]/10 text-[#A7AA63]">
                        {{ users|length }} étudiant{{ users|pluralize }}
                    </span>
                </h3>
            </div>

            {% if users %}
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="bg-[#EAE6D2]">
                            <th class="text-left px-5 py-3 text-sm font-semibold text-[#505039]">
                                <i class="fas fa-user mr-2 text-[#A7AA63]"></i>Utilisateur
                            </th>
                            <th class="text-left px-5 py-3 text-sm font-semibold text-[#505039]">
                                <i class="fas fa-envelope mr-2 text-[#A7AA63]"></i>Email
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-[#C5B8A8]/30">
                        {% for enrolled_user in users %}
                        <tr class="hover:bg-[#EAE6D2]/50 transition-colors">
                            <td class="px-5 py-4">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-8 h-8 rounded-full bg-gradient-to-br from-[#A7AA63] to-[#E2CEAE] flex items-center justify-center text-xs font-bold text-[#312B1E]">
                                        {{ enrolled_user.username|first|upper }}
                                    </div>
                                    <span class="text-[#312B1E] font-medium">{{ enrolled_user.username }}</span>
                                </div>
                            </td>
                            <td class="px-5 py-4 text-[#505039]">{{ enrolled_user.email }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="p-8 text-center">
                <p class="text-[#7C6B51]">Aucun étudiant inscrit à ce cours pour le moment.</p>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-12 bg-[#F2EFE4] rounded-2xl border border-[#C5B8A8]/30">
        <p class="text-[#7C6B51]">Vous n'avez pas de cours ou pas d'étudiants inscrits.</p>
    </div>
    {% endif %}
</div>

<script>
    // Style form inputs
    document.querySelectorAll('input, select, textarea').forEach(el => {
        el.classList.add('w-full', 'px-4', 'py-3', 'rounded-xl');
    });

    // Course card click handler
    document.querySelectorAll('.course-card[data-href]').forEach(function (card) {
        card.addEventListener('click', function (e) {
            if (!e.target.closest('a, button, form')) {
                window.location.href = this.dataset.href;
            }
        });
    });
</script>
{% endblock %}